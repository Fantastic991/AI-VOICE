<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Speaking Practice</title>
<style>
body {
font-family: Arial, sans-serif;
background: #f0f2f5;
text-align: center;
padding: 50px;
}
h1 {
color: #2c3e50;
}
select, button {
margin: 10px;
padding: 10px;
font-size: 16px;
}
#status {
font-size: 18px;
margin-top: 20px;
color: #555;
}
#result {
font-size: 22px;
font-weight: bold;
color: #27ae60;
margin-top: 20px;
}
</style>
</head>
<body>
<h1>🎤 English Speaking Practice</h1>
<p>Select a sentence and try to pronounce it!</p>

<!-- ✅ dropdown หลายประโยค -->
<select id="sentenceSelect">
<option value="My favorite country is South Korea.">My favorite country is South Korea.</option>
<option value="I like learning English every day.">I like learning English every day.</option>
<option value="Traveling makes me happy.">Traveling makes me happy.</option>
<option value="I want to speak English like a native speaker.">I want to speak English like a native speaker.</option>
<option value="The weather is beautiful today.">The weather is beautiful today.</option>
<option value="I enjoy watching Korean dramas.">I enjoy watching Korean dramas.</option>
<option value="Speaking English helps me make new friends.">Speaking English helps me make new friends.</option>
</select>

<!-- ✅ ข้อความที่จะแสดงตามประโยคที่เลือก -->
<h3 id="targetSentence">My favorite country is South Korea.</h3>

<button id="recordButton">Start Recording</button>
<p id="status">Click "Start Recording" to begin.</p>
<p id="result"></p>

<!-- เสียงติ๊ด -->
<audio id="startBeep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="stopBeep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
const recordButton = document.getElementById("recordButton");
const status = document.getElementById("status");
const result = document.getElementById("result");
const startBeep = document.getElementById("startBeep");
const stopBeep = document.getElementById("stopBeep");
const sentenceSelect = document.getElementById("sentenceSelect");
const targetSentence = document.getElementById("targetSentence");

// ✅ เมื่อผู้ใช้เลือกประโยคใหม่
sentenceSelect.addEventListener("change", () => {
targetSentence.textContent = sentenceSelect.value;
result.textContent = "";
});

let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let speakingThreshold = 1500; // ตรวจจับเสียงไวขึ้น
let speakingDetected = false;

recordButton.addEventListener("click", async () => {
if (!isRecording) {
startRecording();
} else {
stopRecording();
}
});

async function startRecording() {
startBeep.play();
result.textContent = "";
status.textContent = "🎙️ Recording... Please speak now!";
recordButton.textContent = "Stop Recording";
isRecording = true;
speakingDetected = false;

try {
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
mediaRecorder = new MediaRecorder(stream);
mediaRecorder.start();

audioChunks = [];

const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);
const analyser = audioContext.createAnalyser();
const dataArray = new Uint8Array(analyser.frequencyBinCount);
source.connect(analyser);

const detectSpeaking = () => {
analyser.getByteFrequencyData(dataArray);
const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
if (avg > 20) {
speakingDetected = true;
}
if (isRecording) requestAnimationFrame(detectSpeaking);
};
detectSpeaking();

mediaRecorder.addEventListener("dataavailable", event => {
audioChunks.push(event.data);
});

} catch (err) {
status.textContent = "⚠️ Microphone access denied.";
}
}

function stopRecording() {
stopBeep.play();
recordButton.textContent = "Start Recording";
isRecording = false;

if (mediaRecorder && mediaRecorder.state !== "inactive") {
mediaRecorder.stop();
mediaRecorder.addEventListener("stop", () => {
if (!speakingDetected) {
status.textContent = "😶 You didn't speak.";
result.textContent = "";
return;
}

status.textContent = "✅ Analyzing pronunciation...";
setTimeout(() => {
const randomScore = (Math.random() * 20 + 80).toFixed(1);
result.textContent = `Your score: ${randomScore}/100`;
status.textContent = "✨ Try another sentence!";
}, 1500);
});
}
}
</script>
</body>
</html>
