"use client";
import React, { useState, useRef } from "react";

export default function Home() {
  const [sentence, setSentence] = useState("I like to travel around the world.");
  const [score, setScore] = useState(null);
  const [recording, setRecording] = useState(false);
  const mediaRecorderRef = useRef(null);
  const audioChunksRef = useRef([]);

  // ЁЯОз р╕Яр╕▒р╕Зр╣Ар╕кр╕╡р╕вр╕З AI (Text-to-Speech)
  const playAIvoice = async () => {
    const res = await fetch("/api/tts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: sentence }),
    });
    const blob = await res.blob();
    const audioUrl = URL.createObjectURL(blob);
    const audio = new Audio(audioUrl);
    audio.play();
  };

  // ЁЯОЩя╕П р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕кр╕╡р╕вр╕Зр╕Юр╕╣р╕Фр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
  const startRecording = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    mediaRecorderRef.current = mediaRecorder;
    audioChunksRef.current = [];

    mediaRecorder.ondataavailable = (e) => audioChunksRef.current.push(e.data);
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunksRef.current, { type: "audio/webm" });
      const formData = new FormData();
      formData.append("audio", audioBlob);
      formData.append("text", sentence);

      const res = await fetch("/api/evaluate", { method: "POST", body: formData });
      const data = await res.json();
      setScore(data.score || "Error");
    };

    mediaRecorder.start();
    setRecording(true);
  };

  const stopRecording = () => {
    mediaRecorderRef.current.stop();
    setRecording(false);
  };

  return (
    <div style={{ textAlign: "center", padding: 20 }}>
      <h1>ЁЯОз AI Voice Practice</h1>
      <p>р╕Ыр╕гр╕░р╣Вр╕вр╕Др╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З:</p>
      <textarea
        value={sentence}
        onChange={(e) => setSentence(e.target.value)}
        rows="2"
        style={{ width: "80%", fontSize: "16px" }}
      />
      <div style={{ marginTop: 20 }}>
        <button onClick={playAIvoice}>ЁЯФК р╕Яр╕▒р╕Зр╣Ар╕кр╕╡р╕вр╕З AI</button>
        {!recording ? (
          <button onClick={startRecording}>ЁЯОЩя╕П р╣Ар╕гр╕┤р╣Ир╕бр╕нр╕▒р╕Фр╣Ар╕кр╕╡р╕вр╕З</button>
        ) : (
          <button onClick={stopRecording}>тП╣я╕П р╕лр╕вр╕╕р╕Фр╕нр╕▒р╕Фр╣Ар╕кр╕╡р╕вр╕З</button>
        )}
      </div>

      {score && (
        <h2 style={{ marginTop: 20 }}>
          тЬЕ р╕Др╕░р╣Бр╕Щр╕Щр╕Бр╕▓р╕гр╕нр╕нр╕Бр╣Ар╕кр╕╡р╕вр╕З: <span>{score}</span>
        </h2>
      )}
    </div>
  );
}
